<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Project 1 : HW 2 for Data Visualization - Visualizations on Selected dataset">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <script src="http://code.jquery.com/jquery-1.11.2.js"></script>
    <script type"text/javascript" src="javascripts/main.js"></script>
    <script src="javascripts/d3.js"></script>
    <style>
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
    </style>
    <title>Project</title>
  </head>
  
  <body>
  <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.3";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
    <!--Header-->
    <div id="myheader">
     <h1>Data Visualization Project</h1>
     <h2>IE590</h2>
    </div>
    <!--IndexLeft-->
   <div id="myIndex">
      <h2>Index</h1>
      <h3><a href="index.html">Project Participants</a></h2>
      <h3><a href="index_sources.html">Potential Data Sources</a></h2>
      <h3><a href="index_time.html">The American Time Use</a></h2>
      <h3><a href="index_exports.html">Colombian Exports</a></h2>
      <h3><a href="index_google.html">Google Analytics</a></h2>
    </div>
    <div id="myBody">
      <!--Body-->
      <!--Exports-->
      <div  id="participants">
        <!--Exports by category-->
        <div>
          <h2><a name="visualization1">Exports goods by category</a></h2>
          <div style="margin-left:40px;margin-right:40px; text-align:justify;">
            <p> The main conclusion that is worth highlighting from the below visualizations is the concentration of the exports in only one category.
            </p>
            <p> Fuels have increased its participation as a percentage of all exports, which can be seen as a risky tendence if it holds on the long term because it creates a dependency on the international prices of those commodities. Because the exchange market is highly sensible on the inflow of dollars, it could ultimately create an extreme revaluation or devaluation of the colombian currency.</p>
            <p> The next treemap shows total exports in millions of dollars for each category. The orange category stands for fuels, the green one for manufactured goods, the blue one for agricultural goods and the red one for others. Each category is divided into subcategories which give a more detailed description on the those exports. 
            </p>
          </div>
        </div>
      </div>
      <div id="graph" style="margin-left:40px;margin-right:40px; text-align:justify;">
        <p style="margin-left:40px;margin-right:40px; text-align:justify;">The Following Stacked area chart shows the behaviour of Colombian exports between the years of 2006 and 2014. From the graph it is clear that all exports have remain constant except for fuels, which have increased signinficantly.</p>
      </div>
      
       
      
      <!--Comments-->
      <div  id="participants">
        <div class="fb-comments" data-href="http://datavisualizationam.github.io/Project_1/index3.html" data-numposts="5" data-colorscheme="light" s></div>
      </div>
    </div>

  <!--Treemap-->
    <script>
      width=650;
      height=700;
      extra=0.1*height;
      var color = d3.scale.category20c();

      //Create svg
      var mySvg= d3.select("#participants").append("svg")
            .attr("width", width)
            .attr("height", height+2*extra);

      //Add titles to the svg
      mySvg.append("text")
        .attr("x",width/2)
        .attr("y",extra)
        .attr("text-anchor","middle")
        .attr("class","svgtitle")
        .text("Colombian exports by year (USD Millions)")

      mySvg.append("text")
        .attr("x",width/2)
        .attr("y",extra*1.8+height/2)
        .attr("text-anchor","middle")
        .attr("class","svgtitle treemaptitle")
        .text("Exports composition (2006)")
      //Create treemap layout
      var myTreemap= d3.layout.treemap()
        .size([width,(height-20)/2])
        .sticky(true)
        .padding(0)
        .value(function(d) {return +d.values.y2006; })    
        .children(function(d) {return d.values; });

      var year=8;
      //Read dataser 
      d3.csv("datasets/goods.csv", function(data) {
        //Create dataset for barchart
        var nestYear=d3.nest()
                    .key(function(d){return "Grandpa";})
                    .key(function(d){return d.anio;})
                    .rollup(function(d){return {
                      exports: d3.sum(d,function(d){return d.expo;})}})
                    .entries(data);
        //Create bars
        mySvg.selectAll("#barchartrect")
          .data(nestYear[0].values)
          .enter()
          .append("rect")
          .attr("x", function(d,i){ return i*width/nestYear[0].values.length;})
          .attr("y", function(d){return extra+height/2*(1-d.values.exports/65000000);})
          .attr("width", width/nestYear[0].values.length)
          .attr("height", function(d){return height/2*(d.values.exports/65000000);})
          .attr("stroke", "white")
          .attr("class","barchart")
          .attr("fill","#33CC99")
          .on("mouseover", function(d,i){
            var myValue = i=== 0? function(d) { return d.values.y2006;}:
              i === 1? function(d) { return d.values.y2007;}:
              i === 2? function(d) { return d.values.y2008;}:
              i === 3? function(d) { return d.values.y2009;}:
              i === 4? function(d) { return d.values.y2010;}:
              i === 5? function(d) { return d.values.y2011;}:
              i === 6? function(d) { return d.values.y2012;}:
              i === 7? function(d) { return d.values.y2013;}:
               function(d) { return d.values.y2014;};
            //Update rectangles
            mySvg.selectAll(".treemaprect")
              .data(myTreemap.value(myValue))
              .transition()
              .duration(300)
              .attr("x", function(d){return d.x;})
              .attr("y", function(d){return 2*extra+d.y+height/2;})
              .attr("width", function(d){return d.dx;})
              .attr("height", function(d){return d.dy;});
            //Update text
            mySvg.selectAll(".treemaptext")
              .data(myTreemap.value(myValue))
              .transition()
              .duration(300)
              .attr("x", function(d){return d.x+d.dx/2-47;})
              .attr("y", function(d){return extra*2+d.y+d.dy/2+5+height/2;})
            //Update hover titles
            mySvg.selectAll(".hovertexttreemap")
              .data(myTreemap.value(myValue))
              .text(function(d){return "Category: "+d.key+"\n"+"Expots (USD millions):"+Math.round(d.value/1000)/1000;});
            //Update treemap title
            mySvg.select(".treemaptitle").text(function(){return "Exports composition ("+(2006+i)+")"})
          })
          .append("title").text(function(d){return Math.round(d.values.exports/1000)/1000;});
        //Create values text for barchart
        mySvg.selectAll("#barcharrvalues") 
          .data(nestYear[0].values)
          .enter()
          .append("text")
          .attr("x", function(d,i){ return (0.25+i)*width/nestYear[0].values.length;})
          .attr("y", function(d){return extra+height/2*(1-d.values.exports/65000000)-3;})
          .attr("class","bartext")
          .text(function(d){return Math.round(d.values.exports/1000)/1000;});
        //Create years text for barchart
        mySvg.selectAll("#barcharrvalues") 
          .data(nestYear[0].values)
          .enter()
          .append("text")
          .attr("x", function(d,i){ return (0.3+i)*width/nestYear[0].values.length;})
          .attr("y", function(d){return extra+20+height/2-5;})
          .attr("class","bartext")
          .attr("fill", "black")
          .text(function(d,i){return 2006+i;});
          

        //Nest dataser for treemap
        var nest=d3.nest()
                    .key(function(d){return "Grandpa";})
                    .key(function(d){return d.area;})
                    .key(function(d){return d.bien;})
                    .rollup(function(d){return {
                      y2006: d3.sum(d,function(d){return d.anio==="2006"?d.expo:0;}),
                      y2007: d3.sum(d,function(d){return d.anio==="2007"?d.expo:0;}),
                      y2008: d3.sum(d,function(d){return d.anio==="2008"?d.expo:0;}),
                      y2009: d3.sum(d,function(d){return d.anio==="2009"?d.expo:0;}),
                      y2010: d3.sum(d,function(d){return d.anio==="2010"?d.expo:0;}),
                      y2011: d3.sum(d,function(d){return d.anio==="2011"?d.expo:0;}),
                      y2012: d3.sum(d,function(d){return d.anio==="2012"?d.expo:0;}),
                      y2013: d3.sum(d,function(d){return d.anio==="2013"?d.expo:0;}),
                      y2014: d3.sum(d,function(d){return d.anio==="2014"?d.expo:0;})
                    }})
                    .entries(data);
        //Create rectangles
        mySvg.selectAll("#recttreemap")
          .data(myTreemap.nodes(nest[0]))
          .enter()
          .append("rect")
            .attr("x", function(d){ return d.x;})
            .attr("y", function(d){return extra*2+d.y+height/2;})
            .attr("width", function(d){return d.dx;})
            .attr("height", function(d){return d.dy;})
            .attr("stroke", "white")
            .attr("class","treemaprect")
            .attr("fill", function(d){return d.children? "white": color(d.parent.value);})
            .append("title").text(function(d){return "Category: "+d.key+"\n"+"Expots (USD millions):"+Math.round(d.value/1000);})
            .attr("class","hovertexttreemap");

        //Create text
        mySvg.selectAll("#treemaptext")
          .data(myTreemap.nodes(nest[0]))
          .enter()
          .append("text")
            .attr("x", function(d){return d.x+d.dx/2-47;})
            .attr("y", function(d){return extra*2+d.y+d.dy/2+5+height/2;})
            .attr("fill", "black")
            .attr("style","font-size:20px")
            .attr("class","treemaptext")
            .text(function(d){return !d.children? null : d.parent? d.key: null;});
      });
    </script>
 
    <script type="text/javascript">
          var format=d3.time.format("%Y");
          var width=800;
          var height=600;
          var padding=95;
          var tooltip = d3.select("body")
              .append("div")
              .attr("class", "remove")
              .style("position", "absolute")
              .style("z-index", "20")
              .style("visibility", "hidden")
              .style("top", "30px")
              .style("left", "55px");
              
          var xScale = d3.time.scale()
             // .domain([2006,2014])
              .range([padding, width-padding]);
          
          var yScale = d3.scale.linear()
             // .domain([0,45000000])
              .range([height-padding, padding]);
          
          var color = d3.scale.category20();
          
          var xAxis = d3.svg.axis()
              .scale(xScale)
              .orient("bottom");
          
          var yAxis = d3.svg.axis()
              .scale(yScale)
              .orient("left");
          
         var stack=d3.layout.stack()
              .offset("zero")
              .values(function(d){return d.values;})
              .x(function(d){return d.anio;})
              .y(function(d){return d.expo;});
          
          var nest = d3.nest()
              .key(function(d) { return d.area; });
          
          var area=d3.svg.area()
              .interpolate("cardinal")
              .x(function(d){return xScale(d.anio);})
              .y0(function(d) { return yScale(d.y0); })
              .y1(function(d) { return yScale(d.y0 + d.y); });
              
          var svg=d3.select("#graph")
              .append("svg")
              .attr("width",width)
              .attr("height",height)
              .append("g")
              .attr("transform","translate("+(padding-20)+","+padding+")");
          
          d3.csv("ExportsByCategory.csv", function(data) {
            
            console.log(nest.entries(data));
            data.forEach(function(d) {
              d.anio = format.parse(d.anio.toString());
              d.expo = +d.expo;
            }); 
            
            var layers = stack(nest.entries(data));
            
            xScale.domain(d3.extent(data, function(d) { console.log(d.anio);return d.anio; }));
            yScale.domain([0, d3.max(data, function(d) { console.log(d.y0 + d.y);return d.y0 + d.y; })]);
                svg.selectAll(".layer")
                .data(layers)
                .enter()
                .append("path")
                .attr("class","layer")
                .attr("d",function(d){console.log(area(d.values));return area(d.values);})
                .attr("transform",function(d){return"translate(-65,"+(-padding+45)+")";})
                .style("fill",function(d,i){return color(i);});
                
                svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(-65,455 )")
                .call(xAxis);
                
                svg.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(30,-50 )")
                .call(yAxis);
                
                svg.append("text")
                .attr("x",200)
                .attr("y",500)
                .text("Year");
                
                svg.append("text")
                .attr("x",-100)
                .attr("y",-25)
                .text("Exports (Million US$")
                .attr("transform","rotate(-90)");
                
                svg.selectAll(".layer")
                .attr("opacity", 1)
                .on("mouseover", function(d, i) {
                  d3.select(this)
                  .classed("hover", true)
                  tooltip.html( "<p>" + d.area + "<br>" + d.expo + "</p>" ).style("visibility", "visible");
                  console.log(d.expo);
                })
                .on("mouseout", function(d, i) {
                  d3.select(this)
                  .classed("hover", false)
                  tooltip.html( "<p>" + d.area + "<br>" + d.expo + "</p>" ).style("visibility", "hidden");
                 console.log(d.expo);
                })

          });
  </script>

  <!--Google Analytics-->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60205051-2', 'auto');
    ga('send', 'pageview');
  </script>
  
  </body>
</html>
